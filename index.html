    <script>
        // Variables globales
        let profileSystem;
        let firebaseReady = false;

        // Inicializar el sistema
        function initializeSystem() {
            const statusElement = document.getElementById('firebase-status');
            
            try {
                if (typeof firebase === 'undefined') {
                    statusElement.innerHTML = '‚ùå Error: Firebase no se carg√≥';
                    statusElement.className = 'error';
                    return;
                }

                // Inicializar sistema de perfiles
                profileSystem = new ProfileSystem();
                
                // Verificar si Firestore est√° listo despu√©s de un tiempo
                setTimeout(() => {
                    if (profileSystem.db) {
                        firebaseReady = true;
                        statusElement.innerHTML = '‚úÖ Sistema listo - Firebase conectado';
                        statusElement.className = 'success';
                        console.log("‚úÖ Todo cargado correctamente");
                    } else {
                        statusElement.innerHTML = '‚ö†Ô∏è Firebase cargando...';
                    }
                }, 2000);

            } catch (error) {
                statusElement.innerHTML = '‚ùå Error inicializando: ' + error.message;
                statusElement.className = 'error';
                console.error("Error:", error);
            }
        }

        // Inicializar cuando la p√°gina cargue
        window.addEventListener('load', initializeSystem);

        // Mostrar men√∫ principal
        function showMainMenu() {
            hideAllSections();
            document.getElementById('main-menu').style.display = 'block';
        }

        // Mostrar selecci√≥n de perfiles
        function showProfileSelection() {
            if (!firebaseReady) {
                alert('‚ö†Ô∏è El sistema a√∫n se est√° cargando. Espera un momento...');
                return;
            }
            
            hideAllSections();
            document.getElementById('profile-selection').style.display = 'block';
            loadProfilesFromFirebase();
        }

        // Mostrar c√≥mo jugar
        function showHowToPlay() {
            hideAllSections();
            document.getElementById('how-to-play').style.display = 'block';
        }

        // Mostrar cr√©ditos
        function showCredits() {
            hideAllSections();
            document.getElementById('credits').style.display = 'block';
        }

        // Ocultar todas las secciones
        function hideAllSections() {
            const sections = ['main-menu', 'profile-selection', 'how-to-play', 'credits'];
            sections.forEach(section => {
                document.getElementById(section).style.display = 'none';
            });
        }

        // Cargar perfiles desde Firebase
        async function loadProfilesFromFirebase() {
            if (!profileSystem) {
                document.getElementById('profiles-list').innerHTML = '<div class="error">‚ùå Sistema no inicializado</div>';
                return;
            }

            const profilesList = document.getElementById('profiles-list');
            profilesList.innerHTML = '<div class="loading">üîÑ Conectando con Firebase...</div>';
            
            try {
                const profiles = await profileSystem.loadAllProfiles();
                
                if (profiles.length === 0) {
                    profilesList.innerHTML = '<div class="loading">üìù No hay perfiles. ¬°Crea el primero!</div>';
                    return;
                }
                
                profilesList.innerHTML = '<h3>üìÇ TUS PERFILES GUARDADOS</h3>';
                profiles.forEach(profile => {
                    const createdDate = profile.created ? new Date(profile.created).toLocaleDateString() : 'Reciente';
                    
                    const profileDiv = document.createElement('div');
                    profileDiv.className = 'profile-item';
                    profileDiv.innerHTML = `
                        <h4>üéñÔ∏è ${profile.name}</h4>
                        <p><strong>Nivel:</strong> ${profile.level} | <strong>Oro:</strong> ${profile.gold}</p>
                        <p><strong>Petr√≥leo:</strong> ${profile.oil} | <strong>Soldados:</strong> ${profile.soldiers}</p>
                        <p><strong>Creado:</strong> ${createdDate}</p>
                        <button class="profile-button" onclick="selectProfile('${profile.id}')">
                            ‚ñ∂Ô∏è JUGAR
                        </button>
                        <button class="delete-button" onclick="deleteProfile('${profile.id}')">
                            üóëÔ∏è ELIMINAR
                        </button>
                    `;
                    profilesList.appendChild(profileDiv);
                });
            } catch (error) {
                let errorHtml = '<div class="error">‚ùå ' + error.message + '</div>';
                
                // Mostrar instrucciones espec√≠ficas para errores de permisos
                if (error.message.includes('reglas de Firestore')) {
                    errorHtml += `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px; margin-top: 10px; text-align: left;">
                            <h4>üìã Para solucionar este error:</h4>
                            <p>1. Ve a <a href="https://console.firebase.google.com" target="_blank" style="color: #00b894;">Firebase Console</a></p>
                            <p>2. Selecciona tu proyecto <strong>empirerevive-6571e</strong></p>
                            <p>3. Ve a <strong>Firestore Database ‚Üí Reglas</strong></p>
                            <p>4. Reemplaza todo con:</p>
                            <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 3px; font-size: 12px;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
                            <p>5. Haz clic en <strong>Publicar</strong></p>
                            <p>6. Actualiza esta p√°gina</p>
                        </div>
                    `;
                }
                
                profilesList.innerHTML = errorHtml;
            }
        }

        // Seleccionar perfil
        async function selectProfile(profileId) {
            if (!profileSystem) {
                alert('‚ùå Sistema no inicializado');
                return;
            }

            try {
                const profile = await profileSystem.loadProfileData(profileId);
                if (profile) {
                    profileSystem.selectProfile(profile);
                    alert(`üéÆ ¬°Bienvenido Comandante ${profile.name}! \n\nCargando Empire & Allies...`);
                    window.location.href = 'home.html';
                }
            } catch (error) {
                alert("‚ùå Error seleccionando perfil: " + error.message);
            }
        }

        // Eliminar perfil
        async function deleteProfile(profileId) {
            if (!profileSystem) {
                alert('‚ùå Sistema no inicializado');
                return;
            }

            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este perfil?\n\nEsta acci√≥n no se puede deshacer.')) {
                try {
                    const success = await profileSystem.deleteProfile(profileId);
                    if (success) {
                        alert('‚úÖ Perfil eliminado correctamente');
                        loadProfilesFromFirebase();
                    }
                } catch (error) {
                    alert('‚ùå Error eliminando perfil: ' + error.message);
                }
            }
        }

        // Crear nuevo perfil
        async function createNewProfile() {
            if (!profileSystem) {
                alert('‚ùå Sistema no inicializado');
                return;
            }

            const profileName = document.getElementById('new-profile-name').value.trim();
            
            if (!profileName) {
                alert("‚ö†Ô∏è Por favor ingresa un nombre para tu comandante");
                return;
            }
            
            if (profileName.length < 3) {
                alert("‚ö†Ô∏è El nombre debe tener al menos 3 caracteres");
                return;
            }
            
            try {
                const createButton = document.querySelector('#profile-selection .menu-button');
                const originalText = createButton.innerHTML;
                createButton.innerHTML = 'üîÑ CREANDO...';
                createButton.disabled = true;
                
                await profileSystem.createProfile(profileName);
                
                createButton.innerHTML = originalText;
                createButton.disabled = false;
                document.getElementById('new-profile-name').value = '';
                
            } catch (error) {
                const createButton = document.querySelector('#profile-selection .menu-button');
                createButton.innerHTML = '‚ú® CREAR PERFIL';
                createButton.disabled = false;
            }
        }

        // Tecla Enter para crear perfil
        document.getElementById('new-profile-name')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createNewProfile();
            }
        });
    </script>
